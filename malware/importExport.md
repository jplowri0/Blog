[Home](https://github.com/jplowri0/Blog/blob/main/home.md) / [Static Analysis](https://github.com/jplowri0/Blog/blob/main/malware/Static_Analysis.md) 
# Imports / Exports
## About 
1. Import: 
* These are the dll's that the malware is attempting to access
* eg. win32, winsockets, winnet  means it is attemping to access netowrk comms
* with the observed dll's google them. See what operations they to perform 
2. Export:
* These are the functions the malware will give to other dll's

## Tools 
- CFF Explorer 
- Google 

## Process
- Select the import directory and note the Dlls used

![hey](https://github.com/jplowri0/Blog/blob/main/malware/importExport.png)

- These are the system DLLs
- Google these 
- Select the Export directory and note the exports
## Runtime Linking
The following functions are commonly used to import functions from DLLs in a Windows PE:
- `LoadLibrary`
- `GetProcAddress`
* `LdrLoadDll`
* `LdrGetProcAddress`
The `LoadLibrary` and `GetProcAddress` will allow an PE to access any function library on the system. When these calls are made, we cannot tell statically which functions they are importing into the program. These functions are not listed in the Headers File. 

## Manipulation Functions
### File
- ReadFile
- CreateFile
- WriteFile
### GUI
The folllowing are clues to a GUI interface
- RegisterClassEx
- SetWindowText
- ShowWindow
- GUI32.dll 
### Launchers
- Shell32.dll - Launch other programs. Common for legit and malware. 
### Processes
- OpenProcess
- GetCurrentProcess
- GetProcessHeap
### Registry
- Advapi32.dll - Use of Registry. Look for Registry Keys in Strings. 

## Process Creation
If we see a function `CreateProcessA` this is a good indication that the sample will be launching additional programs. We need to be vigilant of new programs being spawned. 

## Interesting functions
### Encryption
CRYPTBASE.dll
### File Searching
- FindFirstFile
- FindNextFile 
### Hotkey Registration
- RegisterHotKey
### Keyloggers
 SetWindowsHookEx
 ### Process Termination
 - ZwTerminateProcess 

## Execution
- ShellExecuteW [[DarkAngles]] *https://blog.cyble.com/2022/05/06/rebranded-babuk-ransomware-in-action-darkangels-ransomware-performs-targeted-attack/*


## Collection
### Keyboard Capture
- CallNextHookEx 
- GetActiveWindowTitle
- GetForegroundWindow
- GetKeyboardLayout
- GetKeyboardState
- GetKeyState
- GetModuleHandle
- GetWindowThreadProcessId
- HookCallback
- KeyboardLayout
- MapVirtualKey
- SetHook
- SetWindowsHookEx
- ToUnicodeEx
- UnhookWindowsHookEx
- GetSystemInfo *https://blog.cyble.com/2022/05/06/rebranded-babuk-ransomware-in-action-darkangels-ransomware-performs-targeted-attack/* [[DarkAngles]]


### Screen Caputre
- GetDesktopSnapshotBytes
- GetDesktopSnapshotBytes_old

### Data From Local System
#### Installed Certificates
- GetCAList

## Discovery
### Process Discovery
- processChecker
- GetProcessList
- *Source https://www.zscaler.com/blogs/security-research/no-honor-among-thieves-prynt-stealers-backdoor-exposed* [[Prynt  Stealer]]

### System Owner / User Discovery
#### PE Imports APIs used to set privelegs
OpenProcessToken 
AdjustTokenPriveleges

### File Iteration
#### Wipers 
*In search of files to destroy or corrupt, most wipers recursively iterate through the file system by using Windows APIs*
FindFirstFile && FindNextFile
*-Source https://www.crowdstrike.com/blog/the-anatomy-of-wiper-malware-part-1/*

### System Network Configuration Discovery
- iplookup
- NetShareEnum [[DarkAngles]] *https://blog.cyble.com/2022/05/06/rebranded-babuk-ransomware-in-action-darkangels-ransomware-performs-targeted-attack/*
- GetDriveTypeW - network Drives [[DarkAngles]] *https://blog.cyble.com/2022/05/06/rebranded-babuk-ransomware-in-action-darkangels-ransomware-performs-targeted-attack/*
-

## Defence Evasion
### Access Token Manipulation
#### PE Imports APIs used to set privelegs
AdjustTokenPriveleges
OpenProcessToken - Could be used to manipulate or query other processes

### Debugging 
- Debugger.isLogging() - Method
- OutputDebugString 
- .IsDebuggerPresent() - Method
*- Source https://blog.cyble.com/2022/08/29/mini-stealer-possible-predecessor-of-parrot-stealer/


### Windows File and Defence Permission Modification
#### PE Imports APIs used to change object ACLs
SetFileSecurity



## Command and Control 
### Remote Desktop Software
- DrawIcon
- GetCursorInfo
- GetScreen
- keybd_event
- mouse_event
- GetCursorInfo
- InjectKeyEvent
- InjectMouseEvent
- SendInputMouse

## Exfiltration
### Exfiltration over Web Service
UploadFile [[CodeRAT]]

## Impact
### Endpoint Denial of Service
#### PE imports APIs used to shutdown / lock system
ExitWindowsEx

### Wipers
*The standard method to overwrite a file is by using the **CreateFile** and **WriteFile** API combination. The first is used to grab a handle to the desired file and the second is used to overwrite the file contents with new data*
*-Source https://www.crowdstrike.com/blog/the-anatomy-of-wiper-malware-part-1/*

*Destover overwrites the entire file by determining its size via **GetFileSize**, allocates memory of the same size, excludes files based on their extension and overwrites the file using **WriteFile**.*
![[Pasted image 20220831103049.png]]

*Oftentimes the random buffer is generated via the **seed** and **rand** functions,*
*-Source https://www.crowdstrike.com/blog/the-anatomy-of-wiper-malware-part-1/*

### File Deletion
*Only after replacing the file contents, the file is deleted from disk via the **DeleteFile** API.*
*-Source https://www.crowdstrike.com/blog/the-anatomy-of-wiper-malware-part-1/*

SHEmptyRecycleBinA [[DarkAngles]] *https://blog.cyble.com/2022/05/06/rebranded-babuk-ransomware-in-action-darkangels-ransomware-performs-targeted-attack/


