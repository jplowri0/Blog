[Home](https://github.com/jplowri0/Blog/blob/main/home.md) / [Static Analysis](https://github.com/jplowri0/Blog/blob/main/malware/Static_Analysis.md) 

# Malicious Documents
## Case Studies: 
https://cybergeeks.tech/how-to-analyze-malicious-documents-case-study-of-an-attack-targeting-ukraine-organizations/

https://www.sentinelone.com/labs/who-needs-macros-threat-actors-pivot-to-abusing-explorer-and-other-lolbins-via-windows-shortcuts/

[[VBA Maldoc UTF7]]

## About:
If Office file (non executable) we will not get much out of CFF. This could suggest macros. Then we should look at olevba 

sometimes in macros they'll write in ascii to make it harder to read. Therefore we'll need to convert these characters to see whats happening.

## Frameset Check
https://isc.sans.,.edu/diary/rss/29052

## Tools
CFFexplorer 
olevba.py @44:30
oledump.py. 
zipdump.py
re-search.py
xmldump.py

## On Remnux
### oledump.py 
For Office documents. 
On remnux. can carve into the features of a ole properties 

!!! FILE NAMES CANNOT CONTAIN A SPACE. OLEDUMP.PY WILL NOT HANDLE A SPACE !!! 

To initally list different data streams. If we see an M we know its macro. 
```
oledump.py <FILENAME> 
```
To carve into individual streams: This shows the hex dump.
```
oledump.py -s <STREAMNUMBER> <FILENAME> 
```
To see actual strings and not HEX:
```
oledump.py -s <STREAMNUMBER> -S <FILENAME> 
```
The actual Macro code can be recovered with this: 
```
oledump.py -s <STREAMNUMBER> --vbadecompresscorrupt <FILENAME> 
```
However when conducting an oledump.py, often a warning for no OLE files were found. Proceed to with zipdump.  

### zipdump
https://isc.sans.edu/diary/Analyzing+a+Phishing+Word+Document/28562
Now we're try and identify steams and contents of the file. This will show any binaries, xml files or images. 
```
zipdump.py FILENAME.xlsx
```
Next we will try and extract any notable indicators: 
```
zipdump.py FILENAME.xlsx | python3 re-search.py -u -n url -F officeurls
```
This may return any notable URLs to pivot off. 

Next we can carve into anything of note or interested. Often we like to look into a particular stream. Often we like to look at:

- word/\_rels/document.xml.rels
- xl/\_rels/workbook.xml.rels

Or any other notable xml files. 

To view the xml: 

```
zipdump.py -s STREAMNUMBER -d FILENAME.xlsx | python3 xmldump.py pretty
```
This will return the xml data. 

### Binaries 
If we want to check out a binary we can: 
```
zipdump.py -s STREAMNUMBER -d FILENAME.xlsx
```
And for the hex: 
```
zipdump.py FILENAME.xlsx -s STREAMNUMBER -a | more
```

## PDFs
Use `pdf-parser.py` and `peepdf` which is on REMnux 
###  PeePDF
I donâ€™t really use this, but can show some interesting stuff, give it a go and see what it spits out. 
```
peepdf <FILENAME>
```
Look at the MetaData. It may also give interesting clues to /OpenAction streams. 

We can use `pdf-parser.py` to carve into the stream and find what is going on: 

### pdf-parser.py
Get a summary of the PDF
```
pdf-parser.py <FILENAME> -a
```
Info can be carved out of interesting streams where we can see the code within:
```
pdf-parser.py -s <STREAM NUMBER> -f <FILE NAME>  
```
Objects can be carved: 
```
pdf-parser.py <FILENAME> -o <OBJECT NUMBER> 
```
URLs can also be carved out of the entire PDF: 
```
pdf-parser.py -O <FILENAME> -k /URI 
```

## Process
### Base64 Decoys
https://isc.sans.edu/diary/rss/29032

### CFF Explorer
- In CFF Explorer we may see that PE Size will say 'Not a Portable Executable' and that there is not much available in CFF Explorer. This could suggest Macros 
![[ED039476-4A95-4EF2-AAF3-CC2774A79195.jpeg]]
![hey](https://github.com/jplowri0/Blog/blob/main/malware/Maldoc1.jpeg)

### MalwareBazaar
https://isc.sans.edu/diary/rss/29084
USe this method if no tools available. Or First port of call. 

### olevba.py
- In Command Prompt navigate to olevba.py directory and use the following command: python olevba.py (PATH TO  MALWARE \ MALWARE NAME)

![[4FEF6A2A-22C8-4395-A410-3A60C30F5660.jpeg]]
![hey](https://github.com/jplowri0/Blog/blob/main/malware/Maldoc2.jpeg)

![hey](https://github.com/jplowri0/Blog/blob/main/malware/Maldoc3.jpeg)
This is macro code 

![hey](https://github.com/jplowri0/Blog/blob/main/malware/Maldoc3.jpeg)

Things here to note: 
- Auto Execution is happening once a document is opened 
- Base64 strings
- Command Execution 

## Reports
### 2022 August
https://www.infosecurity-magazine.com/news/cyber-criminals-shift-macros/

https://isc.sans.edu/diary/rss/29034
